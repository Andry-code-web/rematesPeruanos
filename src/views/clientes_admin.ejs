<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes</title>
    <link rel="stylesheet" href="/css/clientes_admin/clientes_admin.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Gesti√≥n de Clientes</h1>
            <p>Sistema de administraci√≥n de compradores</p>
        </header>

        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-icon">üë•</div>
                <div class="stat-info">
                    <h3>Total Clientes</h3>
                    <p id="totalClientes"><%= clientes.length %></p>
                </div>
            </div>

            <div class="stat-box" id="clientesActivosBox">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3>Clientes Activos</h3>
                    <p id="clientesActivos"><%= clientes.filter(c => parseInt(c.oportunidades) > 0).length %></p>
                </div>
            </div>

            <div class="stat-box" id="nuevosClientesBox">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-info">
                    <h3>Nuevos este mes</h3>
                    <p id="clientesNuevos">2</p>
                </div>
            </div>
        </div>

        <div id="nuevosClientesChartContainer" class="chart-container hidden">
            <canvas id="nuevosClientesChart"></canvas>
        </div>

        <div id="searchContainer" class="search-container">
            <input type="text" id="searchInput" placeholder="Buscar por nombre, email o ID...">
            <span class="search-icon">üîç</span>
        </div>

        <div id="tableView">
            <div class="table-container">
                <table class="clients-table">
                    <thead>
                        <tr>
                            <th>CLIENTE</th>
                            <th>CONTACTO</th>
                            <th>REMATES</th>
                            <th>OPORTUNIDADES</th>
                        </tr>
                    </thead>
                    <tbody id="clientesTableBody">
                        <% clientes.forEach(cliente => { %>
                            <tr>
                                <td>
                                    <div class="client-info">
                                        <img src="/img/casa2.jfif" class="client-avatar">
                                        <div>
                                            <div class="client-name"><%= cliente.nombres_apellidos %></div>
                                            <div class="client-id">ID: <%= cliente.id %></div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="contact-info">
                                        <div class="contact-email"><%= cliente.correo %></div>
                                        <div class="contact-phone"><%= cliente.celular %></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="remates-info">
                                        <div class="dni-info">DNI: <%= cliente.dni %></div>
                                        <div class="user-info">Usuario: <%= cliente.usuario %></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="opportunities-badge <%= parseInt(cliente.oportunidades) === 1 ? 'danger' : '' %>" 
                                         onclick="handleOpportunityClick('<%= cliente.id %>', <%= cliente.oportunidades %>)">
                                        Oportunidades
                                        <span class="opportunities-count"><%= cliente.oportunidades %></span>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="cardsView" class="cards-container hidden">
            <% clientes.forEach(cliente => { %>
                <div class="client-card">
                    <div class="card-header">
                        <div class="opportunities-badge <%= parseInt(cliente.oportunidades) === 1 ? 'danger' : '' %>"
                             onclick="handleOpportunityClick('<%= cliente.id %>', <%= cliente.oportunidades %>)">
                            Oportunidades: <%= cliente.oportunidades %>
                        </div>
                        <img src="/img/casa2.jfif" alt="<%= cliente.nombres_apellidos %>" class="card-avatar">
                    </div>
                    <div class="card-body">
                        <h3><%= cliente.nombres_apellidos %></h3>
                        <p class="client-id">ID: <%= cliente.id %></p>
                        <div class="contact-info">
                            <div class="contact-email">Email: <%= cliente.correo %></div>
                            <div class="contact-phone">Tel√©fono: <%= cliente.celular %></div>
                        </div>
                        <div class="additional-info">
                            <div class="info-item">
                                <span>DNI: <%= cliente.dni %></span>
                            </div>
                            <div class="info-item">
                                <span>Usuario: <%= cliente.usuario %></span>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function handleOpportunityClick(clientId, currentOpportunities) {
            const result = await Swal.fire({
                title: '¬øAumentar oportunidades?',
                text: 'El cliente tiene ' + currentOpportunities + ' oportunidad(es). ¬øDesea aumentar sus oportunidades a 10?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Aceptar',
                cancelButtonText: 'Denegar'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/actualizar-oportunidades/${clientId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        await Swal.fire({
                            title: '¬°Completado!',
                            text: 'Se han aumentado las oportunidades correctamente.',
                            icon: 'success'
                        });
                        window.location.reload();
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await Swal.fire({
                        title: 'Error',
                        text: 'Hubo un error al actualizar las oportunidades.',
                        icon: 'error'
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchContainer = document.getElementById('searchContainer');
            const tableView = document.getElementById('tableView');
            const cardsView = document.getElementById('cardsView');
            const clientesActivosBox = document.getElementById('clientesActivosBox');
            const nuevosClientesBox = document.getElementById('nuevosClientesBox');
            const chartContainer = document.getElementById('nuevosClientesChartContainer');
            let chart = null;

            // Initialize views
            searchContainer.style.display = 'block';
            tableView.classList.remove('hidden');
            cardsView.classList.add('hidden');
            chartContainer.classList.add('hidden');
            
            clientesActivosBox.addEventListener('click', function() {
                searchContainer.style.display = 'block';
                if (tableView.classList.contains('hidden')) {
                    tableView.classList.remove('hidden');
                    cardsView.classList.add('hidden');
                } else {
                    tableView.classList.add('hidden');
                    cardsView.classList.remove('hidden');
                }
                chartContainer.classList.add('hidden');
            });

            nuevosClientesBox.addEventListener('click', function() {
                searchContainer.style.display = 'none';
                chartContainer.classList.remove('hidden');
                tableView.classList.add('hidden');
                cardsView.classList.add('hidden');
                if (!chart) {
                    createChart();
                }
            });

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const tableRows = document.querySelectorAll('#clientesTableBody tr');
                const cards = document.querySelectorAll('.client-card');

                tableRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });

                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

            function createChart() {
                const ctx = document.getElementById('nuevosClientesChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [
                            {
                                label: 'Nuevos Clientes',
                                data: [5, 8, 12, 7],
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgb(75, 192, 192)',
                                borderWidth: 1
                            },
                            {
                                label: 'Compras Realizadas',
                                data: [3, 5, 8, 4],
                                backgroundColor: 'rgba(255, 159, 64, 0.6)',
                                borderColor: 'rgb(255, 159, 64)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Nuevos Clientes y Compras por Semana'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Semana'
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>